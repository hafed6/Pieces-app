<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Recherche de pièce détachée</title>
<style>
  body { font-family: Arial, sans-serif; background: #fff; margin: 20px; color: #000; }
  h1 { text-align: center; color: #007acc; margin-bottom: 30px; }

  #search-container {
    max-width: 600px;
    margin: 0 auto 20px auto;
  }
  
  input[type="text"] {
    width: 100%;
    padding: 10px;
    font-size: 16px;
    border: 1px solid #ddd;
    border-radius: 6px;
    box-sizing: border-box;
    margin-bottom: 10px;
  }
  
  #buttons-wrapper {
    max-width: 320px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    gap: 40px;
  }
  
  .button-column {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  
  button {
    padding: 0;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    color: white;
    font-size: 16px;
    width: 150px;
    height: 40px;
    line-height: 40px;
    text-align: center;
  }
  
  #btn-search { background-color: #3399ff; }
  #btn-download { background-color: #ff9800; }
  #btn-import { background-color: #673ab7; }
  #btn-show-add { background-color: #28a745; }
  
  #results {
    max-width: 600px;
    margin: 30px auto;
  }
  
  #add-form {
    display: none;
    max-width: 600px;
    margin: 0 auto 20px auto;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
  }
  
  #img-preview {
    max-width: 120px;
    margin-top: 10px;
    display: none;
    border-radius: 6px;
  }
  
  .result-item {
    display: flex;
    gap: 10px;
    align-items: center;
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
  }
</style>

<!-- ذكاء اصطناعي محلي للبحث الضبابي (Fuzzy Search) -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
</head>
<body>

<h1>Recherche de pièce détachée</h1>

<div id="search-container">
  <input type="text" id="search-input" placeholder="Numéro de pièce ou description..." />
</div>

<div id="buttons-wrapper">
  <div class="button-column">
    <button id="btn-search">Chercher</button>
    <button id="btn-download">Télécharger pieces.json</button>
  </div>
  <div class="button-column">
    <button id="btn-import">Importer pieces.json</button>
    <button id="btn-show-add">Ajouter une pièce</button>
  </div>
</div>

<div style="max-width: 600px; margin: 20px auto;">
  <input type="file" id="file-input" accept="application/json" style="display:none;" />
</div>

<div id="add-form">
  <label for="ref-input">Numéro de pièce</label>
  <input type="text" id="ref-input" placeholder="Ex: 0280218002" /><br/>
  <label for="desc-input">Description</label>
  <input type="text" id="desc-input" placeholder="Description de la pièce" /><br/>
  <label for="img-file-input">Image</label>
  <input type="file" id="img-file-input" accept="image/*" /><br/>
  <img id="img-preview" />
  <button id="btn-add" style="background:#007acc; width: 150px; height: 40px;">Valider</button>
</div>

<div id="results"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ----------------------------------
     بيانات ومرجع للعناصر
  ---------------------------------- */
  let pieces = [];
  let imageBase64 = '';
  let fuse = null;          // محرك البحث الذكي
  let fuseThreshold = 0.3;  // دقة البحث (أقل = أدق، أعلى = أشمل)

  const searchInput   = document.getElementById('search-input');
  const resultsDiv    = document.getElementById('results');
  const btnSearch     = document.getElementById('btn-search');
  const btnShowAdd    = document.getElementById('btn-show-add');
  const btnAdd        = document.getElementById('btn-add');
  const addForm       = document.getElementById('add-form');
  const imgFileInput  = document.getElementById('img-file-input');
  const imgPreview    = document.getElementById('img-preview');

  const btnDownload   = document.getElementById('btn-download');
  const btnImport     = document.getElementById('btn-import');
  const fileInput     = document.getElementById('file-input');

  /* ----------------------------------
     بيانات افتراضية (fallback)
  ---------------------------------- */
  function loadDefaultData() {
    return [
      { ref: "0280218002", description: "Débitmètre Bosch - capteur de masse d'air", image: "" },
      { ref: "1234567890", description: "Capteur de température moteur", image: "" },
      { ref: "9876543210", description: "Injecteur haute pression", image: "" }
    ];
  }

  /* ----------------------------------
     تخزين محلي
  ---------------------------------- */
  function saveToLocalStorage() {
    localStorage.setItem('pieces', JSON.stringify(pieces));
  }

  function loadFromLocalStorage() {
    const data = localStorage.getItem('pieces');
    if (data) {
      try {
        pieces = JSON.parse(data);
        return true;
      } catch {
        pieces = [];
      }
    }
    return false;
  }

  /* ----------------------------------
     ذكاء اصطناعي: بناء فهرس Fuse
  ---------------------------------- */
  function initFuse() {
    fuse = new Fuse(pieces, {
      keys: ['ref', 'description'],
      includeScore: true,
      threshold: fuseThreshold,  // يضبط مدى التسامح مع الأخطاء
      ignoreLocation: true,
      minMatchCharLength: 1
    });
  }

  /* ----------------------------------
     خريطة مرادفات بسيطة (ذكاء محلي)
     يمكنك توسيعها حسب الحاجة
  ---------------------------------- */
  const synonymMap = {
    moteur:      ['engine', 'mot', 'mtr'],
    capteur:     ['sensor', 'sonde'],
    debitmetre:  ['debitmetre', 'debit', 'air flow', 'maf', 'mass air flow', 'bosch'],
    injecteur:   ['injector', 'inj', 'injection'],
    temperature: ['temp', 'heat', 'chauffe']
  };

  function expandQueryWithSynonyms(q) {
    if (!q) return [q];
    const lower = q.toLowerCase().trim();
    let expanded = [q];
    for (const key in synonymMap) {
      if (lower.includes(key) || key.includes(lower)) {
        expanded = expanded.concat(synonymMap[key]);
      }
    }
    return Array.from(new Set(expanded));
  }

  /* ----------------------------------
     ذكاء اصطناعي عبر الإنترنت (اختياري)
     قم بملء endpoint و API key الخاصين بك
     يعمل فقط إذا كان navigator.onLine === true
  ---------------------------------- */
  async function callAISuggestions(query) {
    // مثال توضيحي فقط - عدّل حسب سيرفرك
    // ارجع مصفوفة عناصر: [{ref:"...", description:"...", image:""}, ...]
    try {
      // لا يوجد endpoint حقيقي؛ أعِد مصفوفة فارغة افتراضياً
      return [];
      /*
      const resp = await fetch('https://YOUR_SERVER/ai-suggest', {
        method: 'POST',
        headers: {'Content-Type':'application/json', 'Authorization':'Bearer YOUR_API_KEY'},
        body: JSON.stringify({query})
      });
      if (!resp.ok) throw new Error('AI API error');
      const data = await resp.json();
      return Array.isArray(data) ? data : [];
      */
    } catch(err) {
      console.error('AI suggestion error:', err);
      return [];
    }
  }

  /* ----------------------------------
     تلوين الجزء المتطابق (أزرق فاتح)
  ---------------------------------- */
  function escapeRegExp(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }
  function highlightMatch(text, query) {
    if (!query) return text;
    const safe = escapeRegExp(query);
    const regex = new RegExp(`(${safe})`, 'gi');
    return text.replace(regex, '<span style="color:#3399ff; font-weight:bold;">$1</span>');
  }

  /* ----------------------------------
     عرض النتائج مع الذكاء الإصطناعي
     تسلسل:
       1) بحث مباشر (filter empty => كل شيء)
       2) بحث Fuse (ذكاء محلي)
       3) إن لم توجد نتائج ومحاولة AI (إنترنت)
  ---------------------------------- */
  async function afficherResultats(filter='') {
    resultsDiv.innerHTML = '';
    let itemsToShow = [];
    
    if (!filter) {
      itemsToShow = pieces;
    } else if (fuse) {
      // بحث ضبابي
      const fuseResults = fuse.search(filter);
      if (fuseResults.length > 0) {
        itemsToShow = fuseResults.map(r => r.item);
      } else {
        // محاولة توسيع البحث بالمرادفات محلياً
        const expandedTerms = expandQueryWithSynonyms(filter);
        let gathered = new Set();
        expandedTerms.forEach(term => {
          const r = fuse.search(term);
          r.forEach(x => gathered.add(x.item));
        });
        if (gathered.size > 0) {
          itemsToShow = Array.from(gathered);
        } else if (navigator.onLine) {
          // محاولة ذكاء اصطناعي سحابي (اختياري)
          const ai = await callAISuggestions(filter);
          if (ai.length > 0) {
            itemsToShow = ai;
          }
        }
      }
    } else {
      // إن لم يُبن fuse بعد
      itemsToShow = pieces;
    }

    if (!itemsToShow || itemsToShow.length === 0) {
      resultsDiv.innerHTML = '<p style="color:#777;text-align:center;">Aucun résultat trouvé.</p>';
      return;
    }

    itemsToShow.forEach(item => {
      const div = document.createElement('div');
      div.className = 'result-item';
      const refHTML = highlightMatch(item.ref, filter);
      const descHTML = highlightMatch(item.description, filter);
      div.innerHTML = `
        <img src="${item.image || 'https://via.placeholder.com/120x80?text=No+Image'}"
             width="120" height="80" style="object-fit:contain;">
        <div style="flex-grow:1; color:#000;">
          <strong>Référence : ${refHTML}</strong><br>
          <p>${descHTML}</p>
        </div>
        <button class="btn-delete"
                style="background:#cc3333; border:none; border-radius:6px; width:100px; height:30px; cursor:pointer;">
          Supprimer
        </button>
      `;
      div.querySelector('.btn-delete').onclick = () => {
        if (confirm("Supprimer la pièce " + item.ref + " ?")) {
          // ملاحظة: العناصر القادمة من AI لن تكون بالضرورة ضمن pieces
          const idx = pieces.indexOf(item);
          if (idx !== -1) {
            pieces.splice(idx, 1);
            saveToLocalStorage();
            initFuse();
          }
          afficherResultats(searchInput.value);
        }
      };
      resultsDiv.appendChild(div);
    });
  }

  /* ----------------------------------
     إضافة قطعة جديدة (لا نمنع التكرار كما طلبت)
  ---------------------------------- */
  btnAdd.onclick = () => {
    const ref  = document.getElementById('ref-input').value.trim();
    const desc = document.getElementById('desc-input').value.trim();
    if (!ref || !desc) {
      alert('Veuillez remplir tous les champs.');
      return;
    }
    pieces.push({ ref, description: desc, image: imageBase64 });
    saveToLocalStorage();
    initFuse();
    afficherResultats(searchInput.value);
    document.getElementById('ref-input').value = '';
    document.getElementById('desc-input').value = '';
    imgFileInput.value = '';
    imgPreview.style.display = 'none';
    imageBase64 = '';
    addForm.style.display = 'none';
  };

  /* ----------------------------------
     تحميل صورة Base64
  ---------------------------------- */
  imgFileInput.onchange = () => {
    const file = imgFileInput.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = e => {
        imageBase64 = e.target.result;
        imgPreview.src = imageBase64;
        imgPreview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
  };

  /* ----------------------------------
     بحث (زر + كتابة مباشرة)
  ---------------------------------- */
  btnSearch.onclick = () => afficherResultats(searchInput.value);
  searchInput.addEventListener('keyup', () => afficherResultats(searchInput.value));

  /* ----------------------------------
     إظهار / إخفاء نموذج إضافة قطعة
  ---------------------------------- */
  btnShowAdd.onclick = () => {
    addForm.style.display = addForm.style.display === 'block' ? 'none' : 'block';
  };

  /* ----------------------------------
     تنزيل JSON (نسخة احتياطية)
  ---------------------------------- */
  btnDownload.onclick = () => {
    const blob = new Blob([JSON.stringify(pieces.length ? pieces : loadDefaultData(), null, 2)], { type: "application/json" });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = "pieces.json";
    link.click();
    saveToLocalStorage();
  };

  /* ----------------------------------
     استيراد JSON من ملف خارجي
  ---------------------------------- */
  btnImport.onclick = () => fileInput.click();

  fileInput.onchange = () => {
    const file = fileInput.files[0];
    if (!file) return alert("Aucun fichier sélectionné.");
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = JSON.parse(e.target.result);
        if (Array.isArray(data)) {
          pieces = data;
          saveToLocalStorage();
          initFuse();
          afficherResultats();
          alert("Fichier chargé avec succès !");
        } else {
          alert("Format de fichier invalide.");
        }
      } catch {
        alert("Erreur lors de la lecture du fichier.");
      }
    };
    reader.readAsText(file);
  };

  /* ----------------------------------
     بدء التشغيل: تحميل من LocalStorage أو افتراضي
  ---------------------------------- */
  if (!loadFromLocalStorage()) {
    pieces = loadDefaultData();
    saveToLocalStorage();
  }
  initFuse();
  afficherResultats();
});
</script>

</body>
</html>
