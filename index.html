<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Recherche de pi√®ce d√©tach√©e</title>
<style>
  body { font-family: Arial, sans-serif; background: #fff; margin: 20px; color: #000; }
  h1 { text-align: center; color: #007acc; margin-bottom: 30px; }

  #search-container {
    max-width: 600px;
    margin: 0 auto 20px auto;
    display: flex;
    gap: 8px;
  }
  
  input[type="text"] {
    flex: 1;
    padding: 10px;
    font-size: 16px;
    border: 1px solid #ddd;
    border-radius: 6px;
    box-sizing: border-box;
  }

  #btn-voice {
    background-color: #ff4d4d;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    cursor: pointer;
    color: white;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  #buttons-wrapper {
    max-width: 320px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    gap: 40px;
  }
  
  .button-column {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  
  button {
    padding: 0;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    color: white;
    font-size: 16px;
    width: 150px;
    height: 40px;
    line-height: 40px;
    text-align: center;
  }
  
  #btn-search { background-color: #3399ff; }
  #btn-download { background-color: #ff9800; }
  #btn-import { background-color: #673ab7; }
  #btn-show-add { background-color: #28a745; }
  
  #results {
    max-width: 600px;
    margin: 30px auto;
  }
  
  #add-form {
    display: none;
    max-width: 600px;
    margin: 0 auto 20px auto;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
  }

  #img-preview-container > div {
    margin-bottom: 10px;
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 6px;
  }

  #img-preview-container img {
    max-width: 120px;
    display: block;
    margin: 5px 0;
    border-radius: 6px;
  }

  .img-ref {
    width: 100%;
    padding: 5px;
    font-size: 14px;
    margin-bottom: 5px;
    box-sizing: border-box;
  }

  .remove-btn {
    background: #cc3333;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 12px;
  }

  .result-item {
    display: flex;
    gap: 10px;
    align-items: center;
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
  }

  .highlight { color: #3399ff; font-weight: bold; }
</style>

<script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
</head>
<body>

<h1>Recherche de pi√®ce d√©tach√©e</h1>

<div id="search-container">
  <input type="text" id="search-input" placeholder="Num√©ro de pi√®ce ou description..." />
  <button id="btn-voice" title="Recherche vocale">üé§</button>
</div>

<div id="buttons-wrapper">
  <div class="button-column">
    <button id="btn-search">Chercher</button>
    <button id="btn-download">T√©l√©charger pieces.json</button>
  </div>
  <div class="button-column">
    <button id="btn-import">Importer pieces.json</button>
    <button id="btn-show-add">Ajouter une pi√®ce</button>
  </div>
</div>

<div style="max-width: 600px; margin: 20px auto;">
  <input type="file" id="file-input" accept="application/json" style="display:none;" />
</div>

<div id="add-form">
  <label for="ref-input">Num√©ro de pi√®ce</label>
  <input type="text" id="ref-input" placeholder="Ex: 0280218002" /><br/>
  <label for="desc-input">Description</label>
  <input type="text" id="desc-input" placeholder="Description de la pi√®ce" /><br/>
  <label for="img-file-input">Images</label>
  <input type="file" id="img-file-input" accept="image/*" /><br/>
  <div id="img-preview-container"></div>
  <button id="btn-add" style="background:#007acc; width: 150px; height: 40px;">Valider</button>
</div>

<div id="results"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let pieces = [];
  let imageBase64List = [];
  let fuse = null;
  let fuseThreshold = 0.4;

  const searchInput   = document.getElementById('search-input');
  const resultsDiv    = document.getElementById('results');
  const btnSearch     = document.getElementById('btn-search');
  const btnVoice      = document.getElementById('btn-voice');
  const btnShowAdd    = document.getElementById('btn-show-add');
  const btnAdd        = document.getElementById('btn-add');
  const addForm       = document.getElementById('add-form');
  const imgFileInput  = document.getElementById('img-file-input');
  const imgPreviewContainer = document.getElementById('img-preview-container');
  const btnDownload   = document.getElementById('btn-download');
  const btnImport     = document.getElementById('btn-import');
  const fileInput     = document.getElementById('file-input');

  function loadDefaultData() {
    return [
      { ref: "0280218002", description: "D√©bitm√®tre Bosch - capteur de masse d'air", images: [] },
      { ref: "1234567890", description: "Joint culasse Peugeot Partner M59 DW8B 1.9", images: [] },
      { ref: "9876543210", description: "Injecteur haute pression", images: [] },
      { ref: "5558887777", description: "Joint culasse Citro√´n Berlingo M59 DW8B", images: [] }
    ];
  }

  function saveToLocalStorage() {
    localStorage.setItem('pieces', JSON.stringify(pieces));
  }

  function loadFromLocalStorage() {
    const data = localStorage.getItem('pieces');
    if (data) {
      try {
        pieces = JSON.parse(data);
        return true;
      } catch {
        pieces = [];
      }
    }
    return false;
  }

  function initFuse() {
    fuse = new Fuse(pieces, {
      keys: ['ref', 'description'],
      includeScore: true,
      threshold: fuseThreshold,
      ignoreLocation: true,
      distance: 100
    });
  }

  function escapeRegExp(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  function highlightMatch(text, query) {
    if (!query) return text;
    const words = query.split(/\s+/).filter(w => w.length > 1);
    words.forEach(w => {
      const regex = new RegExp(`(${escapeRegExp(w)})`, 'gi');
      text = text.replace(regex, '<span class="highlight">$1</span>');
    });
    return text;
  }

  function advancedSearch(query) {
    const words = query.toLowerCase().split(/\s+/).filter(w => w);
    if (!words.length) return pieces;
    const fuseResults = fuse.search(query).map(r => r.item);
    return fuseResults.filter(item => {
      const text = (item.ref + " " + item.description).toLowerCase();
      return words.every(w => text.includes(w));
    });
  }

  async function afficherResultats(filter='') {
    resultsDiv.innerHTML = '';
    const itemsToShow = advancedSearch(filter);

    if (!itemsToShow.length) {
      resultsDiv.innerHTML = '<p style="color:#777;text-align:center;">Aucun r√©sultat trouv√©.</p>';
      return;
    }

    itemsToShow.forEach(item => {
      const div = document.createElement('div');
      div.className = 'result-item';
      const refHTML = highlightMatch(item.ref, filter);
      const descHTML = highlightMatch(item.description, filter);

      let imagesHTML = '';
      if (item.images && item.images.length > 0) {
        imagesHTML = item.images.map(obj => `
          <div style="margin-bottom:5px;">
            <img src="${obj.base64}" width="120" height="80" style="object-fit:contain;"><br>
            <small style="color:#333;">R√©f: ${obj.ref || '-'}</small>
          </div>`).join('');
      }

      div.innerHTML = `
        <div style="display:flex;flex-direction:column;flex-grow:1; color:#000;">
          <strong>R√©f√©rence : ${refHTML}</strong>
          <p>${descHTML}</p>
          <div>${imagesHTML}</div>
        </div>
        <button class="btn-delete"
                style="background:#cc3333; border:none; border-radius:6px; width:100px; height:30px; cursor:pointer;">
          Supprimer
        </button>
      `;
      div.querySelector('.btn-delete').onclick = () => {
        if (confirm("Supprimer la pi√®ce " + item.ref + " ?")) {
          const idx = pieces.indexOf(item);
          if (idx !== -1) {
            pieces.splice(idx, 1);
            saveToLocalStorage();
            initFuse();
          }
          afficherResultats(searchInput.value);
        }
      };
      resultsDiv.appendChild(div);
    });
  }

  // Recherche vocale
  btnVoice.addEventListener('click', () => {
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
      alert("La recherche vocale n'est pas support√©e par votre navigateur.");
      return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'fr-FR';
    recognition.start();

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      searchInput.value = transcript;
      afficherResultats(transcript);
    };
  });

  btnAdd.onclick = () => {
    const ref  = document.getElementById('ref-input').value.trim();
    const desc = document.getElementById('desc-input').value.trim();
    if (!ref || !desc) {
      alert('Veuillez remplir tous les champs.');
      return;
    }
    pieces.push({ ref, description: desc, images: imageBase64List });
    saveToLocalStorage();
    initFuse();
    afficherResultats(searchInput.value);
    document.getElementById('ref-input').value = '';
    document.getElementById('desc-input').value = '';
    imgPreviewContainer.innerHTML = '';
    imageBase64List = [];
    imgFileInput.value = '';
    addForm.style.display = 'none';
  };

  imgFileInput.onchange = () => {
    const files = Array.from(imgFileInput.files);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = e => {
        const base64 = e.target.result;
        const imageObj = { base64, ref: "" };
        imageBase64List.push(imageObj);

        const imgWrapper = document.createElement('div');
        const img = document.createElement('img');
        img.src = base64;

        const inputRef = document.createElement('input');
        inputRef.type = "text";
        inputRef.placeholder = "Num√©ro de l'image";
        inputRef.className = "img-ref";
        inputRef.oninput = () => {
          imageObj.ref = inputRef.value;
        };

        const removeBtn = document.createElement('button');
        removeBtn.textContent = "Supprimer";
        removeBtn.className = "remove-btn";
        removeBtn.onclick = () => {
          imgWrapper.remove();
          imageBase64List = imageBase64List.filter(i => i !== imageObj);
        };

        imgWrapper.appendChild(img);
        imgWrapper.appendChild(inputRef);
        imgWrapper.appendChild(removeBtn);
        imgPreviewContainer.appendChild(imgWrapper);
      };
      reader.readAsDataURL(file);
    });
    imgFileInput.value = '';
  };

  btnSearch.onclick = () => afficherResultats(searchInput.value);
  searchInput.addEventListener('keyup', () => afficherResultats(searchInput.value));
  btnShowAdd.onclick = () => {
    addForm.style.display = addForm.style.display === 'block' ? 'none' : 'block';
  };

  btnDownload.onclick = () => {
    const blob = new Blob([JSON.stringify(pieces.length ? pieces : loadDefaultData(), null, 2)], { type: "application/json" });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = "pieces.json";
    link.click();
    saveToLocalStorage();
  };

  btnImport.onclick = () => fileInput.click();
  fileInput.onchange = () => {
    const file = fileInput.files[0];
    if (!file) return alert("Aucun fichier s√©lectionn√©.");
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = JSON.parse(e.target.result);
        if (Array.isArray(data)) {
          pieces = data;
          saveToLocalStorage();
          initFuse();
          afficherResultats();
          alert("Fichier charg√© avec succ√®s !");
        } else {
          alert("Format de fichier invalide.");
        }
      } catch {
        alert("Erreur lors de la lecture du fichier.");
      }
    };
    reader.readAsText(file);
  };

  if (!loadFromLocalStorage()) {
    pieces = loadDefaultData();
    saveToLocalStorage();
  }
  initFuse();
  afficherResultats();
});
</script>

</body>
</html>
